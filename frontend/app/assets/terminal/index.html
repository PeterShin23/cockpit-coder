<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1e1e1e;
            overflow: hidden;
            font-family: 'Courier New', monospace;
        }
        
        #terminal {
            width: 100vw;
            height: 100vh;
        }
        
        .xterm-viewport {
            overflow-y: auto !important;
        }
        
        .xterm-viewport::-webkit-scrollbar {
            width: 8px;
        }
        
        .xterm-viewport::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        
        .xterm-viewport::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 4px;
        }
        
        .xterm-viewport::-webkit-scrollbar-thumb:hover {
            background: #616161;
        }
    </style>
</head>
<body>
    <div id="terminal"></div>
    
    <script src="./xterm.js"></script>
    <script src="./xterm.css"></script>
    
    <script>
        // Terminal setup
        const terminal = new Terminal({
            cursorBlink: true,
            theme: {
                background: '#1e1e1e',
                foreground: '#ffffff',
                cursor: '#ffffff',
                cursorAccent: '#000000',
                selection: '#ffffff44',
                black: '#000000',
                red: '#cd3131',
                green: '#0dbc79',
                yellow: '#e5e510',
                blue: '#2472c8',
                magenta: '#bc3fbc',
                cyan: '#11a8cd',
                white: '#e5e5e5',
                brightBlack: '#666666',
                brightRed: '#f14c4c',
                brightGreen: '#23d18b',
                brightYellow: '#f5f543',
                brightBlue: '#3b8eea',
                brightMagenta: '#d670d6',
                brightCyan: '#29b8db',
                brightWhite: '#e5e5e5'
            }
        });

        // Fit terminal to container
        function fitTerminal() {
            const container = document.getElementById('terminal');
            terminal.fit();
            terminal.scrollToBottom();
        }

        // Initialize terminal
        terminal.open(document.getElementById('terminal'));
        fitTerminal();

        // Handle window resize
        window.addEventListener('resize', fitTerminal);

        // WebSocket connection
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 1000;

        function connectWebSocket() {
            const url = new URL(window.location.href);
            const sessionId = url.searchParams.get('sessionId');
            const token = url.searchParams.get('token');

            if (!sessionId || !token) {
                console.error('Missing sessionId or token');
                return;
            }

            ws = new WebSocket(`ws://${window.location.host}/ws/pty?sessionId=${sessionId}&token=${token}`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
                terminal.write('\r\nConnected to terminal\r\n');
            };

            ws.onmessage = (event) => {
                terminal.write(event.data);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                terminal.write('\r\nConnection closed\r\n');
                attemptReconnect();
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                terminal.write('\r\nConnection error\r\n');
            };
        }

        function attemptReconnect() {
            if (reconnectAttempts >= maxReconnectAttempts) {
                console.log('Max reconnection attempts reached');
                return;
            }

            reconnectAttempts++;
            const delay = reconnectDelay * Math.pow(2, reconnectAttempts - 1);
            
            console.log(`Attempting to reconnect in ${delay}ms (attempt ${reconnectAttempts})`);
            
            setTimeout(() => {
                connectWebSocket();
            }, delay);
        }

        // Handle terminal input
        terminal.onData((data) => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(data);
            }
        });

        // Handle terminal resize
        terminal.onResize((size) => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'resize',
                    cols: size.cols,
                    rows: size.rows
                }));
            }
        });

        // Connect to WebSocket
        connectWebSocket();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
